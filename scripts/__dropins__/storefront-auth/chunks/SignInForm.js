import{jsxs as x,jsx as n}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as W,classes as X}from"@dropins/tools/lib.js";import{g as Y,c as w,u as Z,T as $,F as z,B as G}from"./useInLineAlert.js";import{useState as _,useCallback as b,useEffect as q,useMemo as O}from"@dropins/tools/preact-hooks.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/recaptcha.js";import{a as R}from"./getCustomerToken.js";import{r as tt}from"./resendConfirmationEmail.js";import{s as at,a as rt}from"./simplifyTransformAttributesForm.js";import{c as et}from"./confirmEmail.js";import{useText as H}from"@dropins/tools/i18n.js";import{InLineAlert as st,InputPassword as ot}from"@dropins/tools/components.js";import{E as it}from"./EmailConfirmationForm.js";const nt=({emailConfirmationStatusMessage:t,translations:r,initialEmailValue:o,routeSignUp:c,routeForgotPassword:u,routeRedirectOnSignIn:y,onErrorCallback:d,setActiveComponent:a,onSuccessCallback:f,onSignUpLinkClick:l,handleSetInLineAlertProps:e,routeRedirectOnEmailConfirmationClose:E})=>{const[M,S]=_(""),[h,I]=_(!1),[g,F]=_(""),[A,T]=_(!1),[L,p]=_({userName:"",status:!1}),[k,N]=_(!1),P=b(async i=>{await tt(i),I(!0),e({})},[e]);q(()=>{t!=null&&t.text&&e({text:t.text,type:t.status?t.status:void 0})},[t,e]);const C=b(i=>r?x("span",{className:"auth-signInForm__resend-email-notification",children:[r.resendEmailInformationText," ",n("button",{onClick:()=>P(i),children:r.resendEmailButtonText})," ",r.resendEmailAdditionalText]}):"",[P,r]),B=b(async i=>{var K;e({}),N(!0);const m=Y(i.target);if(m.password||(T(!0),N(!1)),m!=null&&m.email&&(m!=null&&m.password)){const{email:D,password:Q}=m,s=await R({email:D,password:Q,handleSetInLineAlertProps:e,onErrorCallback:d,translations:r});if((K=s==null?void 0:s.errorMessage)!=null&&K.length){S(D);const V=s.errorMessage.includes("This account isn't confirmed. Verify and try again.")?C(D):s.errorMessage;e({text:V,type:"error"}),F("")}s!=null&&s.userName&&(i.target.reset(),w(y)?window.location.href=y():(f==null||f({userName:s==null?void 0:s.userName,status:!0}),p({userName:s==null?void 0:s.userName,status:!0}))),T(!1)}N(!1),F("")},[C,e,r,d,y,f]),U=b(()=>{if(w(a)){a("resetPasswordForm");return}w(u)&&(window.location.href=u())},[u,a]),v=b(()=>{if(w(l)&&l(),w(a)){a("signUpForm");return}w(c)&&(window.location.href=c())},[l,c,a]),j=O(()=>{const i=at(rt);return o!=null&&o.length?i==null?void 0:i.map(m=>({...m,defaultValue:o})):i},[o]),J=b(()=>{e({}),w(E)?window.location.href=E():I(!1)},[e,E]);return{userEmail:M,defaultEnhancedEmailFields:j,passwordError:A,isSuccessful:L,isLoading:k,signInPasswordValue:g,showEmailConfirmationForm:h,setShowEmailConfirmationForm:I,setSignInPasswordValue:F,submitLogInUser:B,forgotPasswordCallback:U,onSignUpLinkClickCallback:v,handledOnPrimaryButtonClick:J}},mt=()=>{let t=new URL(window.location.href),r=t.searchParams.get("email"),o=t.searchParams.get("key");r&&o&&(t.searchParams.delete("email"),t.searchParams.delete("key"),window.history.replaceState({},document.title,t.toString()))},ct=({enableEmailConfirmation:t})=>{const r=H({accountConfirmMessage:"Auth.EmailConfirmationForm.accountConfirmMessage",accountConfirmationEmailSuccessMessage:"Auth.EmailConfirmationForm.accountConfirmationEmailSuccessMessage"}),[o,c]=_({text:"",status:""});return q(()=>{if(t){const{search:u}=window.location;u.includes("email=")&&u.includes("key=")&&(async()=>{var f,l,e;const d=new URLSearchParams(u),a=await et({customerEmail:d.get("email"),customerConfirmationKey:d.get("key")});if(!a)return null;(f=a==null?void 0:a.errors)!=null&&f.length?c({text:a==null?void 0:a.errors[0].message,status:"error"}):(c({text:a.data.confirmEmail.customer.email?r.accountConfirmationEmailSuccessMessage.replace("{email}",(e=(l=a==null?void 0:a.data)==null?void 0:l.confirmEmail.customer)==null?void 0:e.email):r.accountConfirmMessage,status:"success"}),mt())})()}},[t,r]),{emailConfirmationStatusMessage:o}},Nt=({slots:t,formSize:r="default",initialEmailValue:o="",renderSignUpLink:c=!1,enableEmailConfirmation:u=!1,hideCloseBtnOnEmailConfirmation:y=!1,routeRedirectOnEmailConfirmationClose:d,routeRedirectOnSignIn:a,routeForgotPassword:f,routeSignUp:l,onSuccessCallback:e,setActiveComponent:E,onErrorCallback:M,onSignUpLinkClick:S})=>{const h=H({title:"Auth.SignInForm.title",buttonPrimary:"Auth.SignInForm.buttonPrimary",buttonSecondary:"Auth.SignInForm.buttonSecondary",buttonTertiary:"Auth.SignInForm.buttonTertiary",resendEmailInformationText:"Auth.Notification.resendEmailNotification.informationText",resendEmailButtonText:"Auth.Notification.resendEmailNotification.buttonText",resendEmailAdditionalText:"Auth.Notification.resendEmailNotification.additionalText",customerTokenErrorMessage:"Auth.Api.customerTokenErrorMessage"}),{emailConfirmationStatusMessage:I}=ct({enableEmailConfirmation:u}),{inLineAlertProps:g,handleSetInLineAlertProps:F}=Z(),{userEmail:A,defaultEnhancedEmailFields:T,passwordError:L,isSuccessful:p,isLoading:k,signInPasswordValue:N,showEmailConfirmationForm:P,setSignInPasswordValue:C,submitLogInUser:B,forgotPasswordCallback:U,onSignUpLinkClickCallback:v,handledOnPrimaryButtonClick:j}=nt({translations:h,emailConfirmationStatusMessage:I,initialEmailValue:o,routeSignUp:l,routeForgotPassword:f,routeRedirectOnSignIn:a,setActiveComponent:E,onErrorCallback:M,onSuccessCallback:e,onSignUpLinkClick:S,handleSetInLineAlertProps:F,routeRedirectOnEmailConfirmationClose:d});return p.status&&(t!=null&&t.SuccessNotification)?n(W,{"data-testid":"successNotificationTestId",name:"SuccessNotification",slot:t==null?void 0:t.SuccessNotification,context:{isSuccessful:p}}):P?n(it,{formSize:r,userEmail:A,inLineAlertProps:g,hideCloseBtnOnEmailConfirmation:y,handleSetInLineAlertProps:F,onPrimaryButtonClick:j}):x("div",{className:X(["auth-signInForm",r]),"data-testid":"signInForm",children:[n($,{text:h.title,bottomLine:!1,className:"auth-signInForm__title"}),g.text?n(st,{"data-testid":"authInLineAlert",className:"auth-signInForm__notification",type:g.type,variant:"secondary",heading:g.text,icon:g.icon}):null,x(z,{name:"signIn_form",className:"auth-signInForm__form",submitCallback:B,isLoading:k,fieldsConfig:T,children:[n(ot,{className:"auth-signInForm__form__password",autoComplete:"current-password",error:L,defaultValue:N,onValue:C,hideStatusIndicator:!0}),x("div",{className:"auth-signInForm__form__buttons",children:[x("div",{className:"auth-signInForm__form__buttons--combine",children:[n(G,{type:"button",variant:"tertiary",style:{padding:0},buttonText:h.buttonTertiary,className:"auth-signInForm__button auth-signInForm__button--forgot",enableLoader:!1,onClick:U,"data-testid":"switchToSignUp"}),c?n("span",{}):null,c?n(G,{type:"button",variant:"tertiary",style:{padding:0},buttonText:h.buttonSecondary,className:"auth-signInForm__button auth-signInForm__button--signup",enableLoader:!1,onClick:v}):null]}),n(G,{type:"submit",buttonText:h.buttonPrimary,variant:"primary",className:"auth-signInForm__button auth-signInForm__button--submit",enableLoader:k})]})]}),n("div",{id:"generateCustomerToken"})]})};export{Nt as S};
